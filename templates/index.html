<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deepfake Detector with XAI</title>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        .container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #0056b3; }
        .upload-section { margin-bottom: 30px; padding: 20px; border: 1px dashed #ccc; border-radius: 5px; background-color: #e9f7ff; }
        .prediction-section, .xai-section { margin-top: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background-color: #f9f9f9; }
        .result-item { margin-bottom: 10px; }
        .error { color: red; font-weight: bold; }
        img.uploaded-image { max-width: 100%; height: auto; display: block; margin-top: 15px; border: 1px solid #eee; }
        img.xai-image { max-width: 100%; height: auto; display: block; margin-top: 10px; border: 1px solid #eee; }
        pre { background-color: #eee; padding: 10px; border-radius: 5px; overflow-x: auto; }
        .flex-container { display: flex; flex-wrap: wrap; gap: 20px; }
        .flex-item { flex: 1; min-width: 300px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Deepfake Detector with XAI</h1>

        <div class="upload-section">
            <p>Upload an image to detect if it's a deepfake and get explanations.</p>
            <form method="POST" enctype="multipart/form-data">
                <input type="file" name="file" accept=".png, .jpg, .jpeg">
                <input type="submit" value="Upload and Analyze">
            </form>
            {% if error %}
                <p class="error">{{ error }}</p>
            {% endif %}
        </div>

        {% if original_image_url %}
            <h2>Original Image</h2>
            <img src="{{ original_image_url }}" alt="Uploaded Image" class="uploaded-image">
        {% endif %}

        {% if prediction_info %}
            <div class="prediction-section">
                <h2>Prediction Result</h2>
                <div class="result-item">
                    <strong>Label:</strong> {{ prediction_info.label }}
                </div>
                <div class="result-item">
                    <strong>Confidence:</strong> {{ prediction_info.confidence }}%
                </div>
                <div class="result-item">
                    <strong>Raw Prediction Score:</strong> {{ '%.4f' % prediction_info.raw_prediction }}
                </div>
                <div class="result-item">
                    <strong>Textual Explanation:</strong> {{ xai_results.textual_explanation | safe }}
                </div>
            </div>
        {% endif %}

        {% if xai_results and not xai_results.error %}
            <div class="xai-section">
                <h2>XAI Explanations</h2>

                <h3>Uncertainty Quantification</h3>
                <div class="result-item">
                    <strong>Certainty Score:</strong> {{ '%.2f' % xai_results.uncertainty.certainty_score }}
                </div>
                <div class="result-item">
                    <strong>Uncertainty Score:</strong> {{ xai_results.uncertainty.uncertainty_score }}%
                </div>
                <div class="result-item">
                    <small>{{ xai_results.uncertainty.explanation }}</small>
                </div>

                <div class="flex-container">
                    <div class="flex-item">
                        <h3>LIME Explanation</h3>
                        <p>{{ xai_results.lime_explanation_text }}</p>
                        {% if xai_results.lime_explanation_img_base64 %}
                            <img src="data:image/png;base64,{{ xai_results.lime_explanation_img_base64 }}" alt="LIME Explanation" class="xai-image">
                        {% else %}
                            <p>No LIME image generated.</p>
                        {% endif %}
                    </div>

                    <div class="flex-item">
                        <h3>SHAP Explanation</h3>
                        <p>{{ xai_results.shap_explanation_text }}</p>
                        {% if xai_results.shap_explanation_img_base64 %}
                            <img src="data:image/png;base64,{{ xai_results.shap_explanation_img_base64 }}" alt="SHAP Explanation" class="xai-image">
                        {% else %}
                            <p>No SHAP image generated.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
</body>
</html>